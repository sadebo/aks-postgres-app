name: Provision AKS + Deploy App

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Choose deployment environment"
        required: true
        default: "dev"
        type: choice
        options:
        - dev
        - test
        - prod
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.6.0

    - name: Run Bootstrap (Remote State)
      run: |
        terraform -chdir=bootstrap init -input=false
        terraform -chdir=bootstrap apply -auto-approve

  infra:
    runs-on: ubuntu-latest
    needs: bootstrap
    steps:
    - uses: actions/checkout@v3

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.6.0

    - name: Terraform Init (with remote backend)
      run: terraform -chdir=terraform init -input=false

    - name: Terraform Apply (main project)
      run: terraform -chdir=terraform apply -auto-approve

    - name: Save kubeconfig
      run: |
        terraform -chdir=terraform output -raw kube_config > kubeconfig.yaml
        echo "KUBECONFIG=$(pwd)/kubeconfig.yaml" >> $GITHUB_ENV

  build:
    runs-on: ubuntu-latest
    needs: infra
    steps:
    - uses: actions/checkout@v3

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Azure Container Registry Login
      run: az acr login --name myaksacr01

    - name: Build and Push Docker Image
      uses: docker/build-push-action@v4
      with:
        context: ./app
        push: true
        tags: myaksacr01.azurecr.io/flask-app:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - uses: actions/checkout@v3

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: Deploy App + Postgres (Kustomize Overlay)
      run: |
        ENVIRONMENT=${{ github.event.inputs.environment || 'dev' }}
        echo "Deploying environment: $ENVIRONMENT"
        kubectl apply -k k8s/overlays/$ENVIRONMENT
