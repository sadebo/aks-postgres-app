name: Destroy AKS + ACR Infra

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Which environment to destroy"
        required: true
        default: "dev"
        type: choice
        options: [ dev, test, prod ]

jobs:
  destroy:
    runs-on: ubuntu-latest
    environment:
      name: destroy-approval # üîê requires manual approval
    steps:
    - uses: actions/checkout@v3

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.6.0

    - name: Terraform Init
      run: terraform -chdir=terraform init -input=false \ -var client_id=${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }} \ -var client_secret=${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }} \ -var tenant_id=${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }} \ -var subscription_id=${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}

    - name: Terraform Destroy
      run: terraform -chdir=terraform destroy -auto-approve \ -var client_id=${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }} \ -var client_secret=${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }} \ -var tenant_id=${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }} \ -var subscription_id=${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}

    - name: Cleanup K8s Resources
      if: always()
      run: |
        ENVIRONMENT=${{ github.event.inputs.environment || 'dev' }}
        echo "Cleaning up Kustomize overlay for: $ENVIRONMENT"
        kubectl delete -k k8s/overlays/$ENVIRONMENT || true
