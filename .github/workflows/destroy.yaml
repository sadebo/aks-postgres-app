name: Destroy AKS + ACR Infra

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Which environment to destroy"
        required: true
        default: "dev"
        type: choice
        options: [ dev, test, prod ]

jobs:
  destroy:
    runs-on: ubuntu-latest
    environment:
      name: destroy-approval # ðŸ” requires manual approval
    steps:
    - uses: actions/checkout@v3

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.6.0

    - name: Export ARM_* env vars
      run: |
        echo "ARM_CLIENT_ID=${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}" >> $GITHUB_ENV
        echo "ARM_CLIENT_SECRET=${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}" >> $GITHUB_ENV
        echo "ARM_TENANT_ID=${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}" >> $GITHUB_ENV
        echo "ARM_SUBSCRIPTION_ID=${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}" >> $GITHUB_ENV

    - name: Terraform Init
      run: terraform -chdir=terraform init -input=false

    - name: Terraform Destroy
      run: terraform -chdir=terraform destroy -auto-approve

    - name: Cleanup K8s Resources
      if: always()
      run: |
        ENVIRONMENT=${{ github.event.inputs.environment || 'dev' }}
        echo "Cleaning up Kustomize overlay for: $ENVIRONMENT"
        kubectl delete -k k8s/overlays/$ENVIRONMENT || true
